<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="library/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="style/main.css">
    <title>Toko Mas Duta Sumedang Online Store | Cart</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
    }
    
    .main-nav {
        background: linear-gradient(135deg, #ffb400, #ff8400);
        padding: 15px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main-nav h1 {
        color: #fff;
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        text-transform: uppercase;
    }
    
    .cart-section {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        padding: 30px;
        margin-top: 40px;
    }
    
    .cart-section h2 {
        font-size: 2rem;
        font-weight: 700;
        color: #ff8400;
        margin-bottom: 25px;
        text-align: center;
    }
    
    .table {
        border-collapse: collapse;
        width: 100%;
    }
    
    .table th {
        background-color: #ff8400;
        color: white;
        font-weight: 700;
        text-align: center;
        padding: 15px;
    }
    
    .table td {
        text-align: center;
        padding: 15px;
        border-bottom: 1px solid #ddd;
    }
    
    .table tbody tr:hover {
        background-color: #f1f1f1;
    }
    
    .btn-checkout {
        background: linear-gradient(135deg, #28a745, #218838);
        color: #fff;
        font-size: 1.2rem;
        padding: 12px 30px;
        border-radius: 30px;
        font-weight: bold;
        transition: all 0.3s ease;
        text-align: center;
        display: inline-block;
    }
    
    .btn-checkout:hover {
        background: linear-gradient(135deg, #218838, #1e7e34);
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .total-section {
        margin-top: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #ffb400;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .total-section h4 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
    }
    
    footer {
        background: #333;
        color: #fff;
        text-align: center;
        padding: 20px;
        margin-top: 50px;
        font-size: 1rem;
        font-weight: 500;
    }

        @media (max-width: 768px) {
            .cart-section {
                padding: 20px;
            }

            .main-nav h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="main-nav">
            <div class="brand text-main">
                <a href="https://proyek3webtokoemas.github.io/FEPROYEK1/index.html">
                    <h1>TOKO MAS DUTA SUMEDANG</h1>
                </a>
            </div>
        </nav>
    </header>

    <main>
        <section class="cart-section">
            <div class="container">
                <h2 class="text-center">Keranjang Belanja</h2>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Produk</th>
                                <th>Jumlah</th>
                                <th>Total Harga</th>
                                <th>Status Pembayaran</th>
                                <th>Checkout</th>
                            </tr>
                        </thead>
                        <tbody id="cart-table-body">
                            <!-- Cart items will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="total-section">
                    <h4>Total: Rp 0</h4>
                    <a href="checkout.html" class="btn btn-checkout">Checkout</a>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>Toko Mas Duta Sumedang Online Store Copyright &copy; 2020 All Rights Reserved</p>
        </div>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("üöÄ Halaman dimuat, memulai proses...");
        
            // Ambil total harga dari localStorage dan set ke input gross_amount
            const totalHarga = localStorage.getItem("cartTotal") || "0";
            console.log("üí∞ Total Harga dari localStorage:", totalHarga);
        
            // Format totalHarga menjadi format Rupiah
            const formattedTotal = formatRupiah(totalHarga);
        
            // Set nilai asli ke input gross_amount
            const grossAmountInput = document.getElementById("gross_amount");
            if (grossAmountInput) {
                grossAmountInput.value = totalHarga;
                grossAmountInput.setAttribute("readonly", true);
            }
        
            // Tampilkan di halaman
            const grossAmountDisplay = document.getElementById("gross_amount_display");
            if (grossAmountDisplay) {
                grossAmountDisplay.innerText = formattedTotal;
            }
        
            // Tampilkan format di tabel jumlah pembayaran
            const paymentTableAmount = document.getElementById("payment-amount");
            if (paymentTableAmount) {
                paymentTableAmount.innerText = formattedTotal;
            }
        
            // Event listener untuk tombol bayar
            const payButton = document.getElementById("pay-button");
            if (payButton) {
                payButton.addEventListener("click", async function () {
                    console.log("üõí Tombol bayar diklik!");
        
                    const grossAmount = parseInt(grossAmountInput.value);
                    const firstName = document.getElementById("first_name").value;
                    const email = document.getElementById("email").value;
                    const phone = document.getElementById("phone").value;
        
                    console.log("üìã Data input pengguna:");
                    console.log(" - Nama:", firstName);
                    console.log(" - Email:", email);
                    console.log(" - Phone:", phone);
                    console.log(" - Gross Amount:", grossAmount);
        
                    // Validasi inputan
                    if (!firstName || !email || !phone) {
                        Swal.fire("Error", "Semua kolom harus diisi!", "warning");
                        console.error("‚ùå Validasi gagal: Ada inputan yang kosong.");
                        return;
                    }
        
                    // **Buat order_id unik dengan timestamp**
                    const orderId = `ORDER-${Date.now()}`;
                    console.log("üÜî Order ID yang dibuat:", orderId);
        
                    try {
                        console.log("üîó Mengirim permintaan ke backend...");
                        const response = await fetch("https://be-3.vercel.app/payment", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                order_id: orderId, // Kirim order_id ke backend
                                gross_amount: grossAmount,
                                customer_details: { name: firstName, email, phone }
                            })
                        });
        
                        console.log("üì° Menunggu respons dari backend...");
                        const data = await response.json();
                        console.log("‚úÖ Respons dari backend:", data);
        
                        if (data.redirect_url) {
                            // **Simpan order_id di localStorage sebelum redirect**
                            localStorage.setItem("currentOrderId", orderId);
                            console.log("üíæ Order ID disimpan di localStorage:", orderId);
        
                            // Redirect ke halaman pembayaran Midtrans
                            console.log("‚û°Ô∏è Mengalihkan ke Midtrans:", data.redirect_url);
                            window.location.href = data.redirect_url;
                        } else {
                            Swal.fire("Kesalahan", "URL pembayaran tidak ditemukan", "error");
                            console.error("‚ùå Kesalahan: URL pembayaran tidak ada dalam respons backend.");
                        }
                    } catch (error) {
                        Swal.fire("Kesalahan", "Terjadi kesalahan saat memproses pembayaran.", "error");
                        console.error("‚ùå Error saat menghubungi backend:", error);
                    }
                });
            }
        });
        
        // **Ambil order_id di halaman lain (contoh: midtrans.html)**
        function getOrderIdFromLocalStorage() {
            const orderId = localStorage.getItem("currentOrderId");
            if (!orderId) {
                console.warn("‚ö†Ô∏è Order ID tidak ditemukan di localStorage.");
                return "undefined";
            }
            console.log("üì¶ Order ID dari localStorage:", orderId);
            return orderId;
        }
        
        // Fungsi format Rupiah
        function formatRupiah(angka) {
            const numberString = angka.toString().replace(/[^,\d]/g, '');
            const split = numberString.split(',');
            const sisa = split[0].length % 3;
            let rupiah = split[0].substr(0, sisa);
            const ribuan = split[0].substr(sisa).match(/\d{3}/gi);
        
            if (ribuan) {
                const separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }
        
            rupiah = split[1] !== undefined ? rupiah + ',' + split[1] : rupiah;
            return 'Rp ' + rupiah;
        }        
    </script>    
</body>
</html>
