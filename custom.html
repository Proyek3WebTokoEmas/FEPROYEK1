<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="library/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="style/main.css" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <title>TOKO MAS DUTA SUMEDANG | Custom Jewelry</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
      }

      .custom-form {
        background-color: #ffffff;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .custom-form h2 {
        font-weight: bold;
        color: #333333;
        margin-bottom: 20px;
      }

      .custom-form .form-label {
        font-weight: 600;
        color: #555555;
      }

      .custom-form .form-control,
      .custom-form .form-select {
        border-radius: 8px;
        border: 1px solid #cccccc;
        padding: 10px;
      }

      .custom-form .form-control:focus,
      .custom-form .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      .btn-submit {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        transition: background-color 0.3s ease;
      }

      .btn-submit:hover {
        background-color: #0056b3;
      }

      #preview-image {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        display: none;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .text-main {
        font-weight: bold;
        font-size: 1.5rem;
        color: #333333;
      }

      .text-center button {
        display: inline-block;
        margin: 5px; /* Jarak antar tombol jika ada */
      }

      .text-second {
        color: #777777;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="main-nav">
        <div class="brand text-main">
          <a href="index.html">
            <h1>TOKO MAS DUTA SUMEDANG</h1>
          </a>
        </div>
        <div class="links">
          <ul>
            <li><a href="wedding.html">Wedding</a></li>
            <li><a href="custom.html" class="active">Custom</a></li>
            <li><a href="categories.html">Categories</a></li>
            <li><a href="blog.html">Blog</a></li>
            <li><a href="contacts.html">Contacts</a></li>
          </ul>
        </div>
        <div class="icon-for-user">
          <a href="loginregis.html">
            <img src="assets/icons/person.svg" alt="person" />
          </a>
          <a href="cart.html">
            <img src="assets/icons/shop-bag.svg" alt="shopping bag" />
          </a>
        </div>
      </nav>
    </header>

    <main>
      <section class="custom-section py-5">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="custom-form">
                <h2 class="text-center">Custom Jewelry Order</h2>
                <form id="customOrderForm">
                  <div class="mb-4">
                    <label for="productType" class="form-label"
                      >Jenis Perhiasan</label
                    >
                    <select
                      class="form-select"
                      id="productType"
                      name="productType"
                      required
                    >
                      <option value="cincin">Cincin</option>
                      <option value="gelang">Gelang</option>
                      <option value="kalung">Kalung</option>
                      <option value="anting">Anting</option>
                    </select>
                  </div>

                  <div class="mb-4">
                    <label for="goldType" class="form-label">Jenis Emas</label>
                    <select
                      class="form-select"
                      id="goldType"
                      name="goldType"
                      required
                    >
                      <option value="24k">Emas 24K - Rp 1.485.700</option>
                      <option value="22k">Emas 22K - Rp 3.121.420</option>
                      <option value="18k">Emas 18K - Rp 1.327.100</option>
                    </select>
                  </div>

                  <div class="mb-4">
                    <label for="goldWeight" class="form-label"
                      >Berat Emas (gram)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="goldWeight"
                      name="goldWeight"
                      min="1"
                      max="100"
                      placeholder="Masukkan berat emas"
                      required
                    />
                  </div>

                  <div class="mb-4">
                    <label for="mixMaterial" class="form-label"
                      >Campuran Tambahan</label
                    >
                    <select
                      class="form-select"
                      id="mixMaterial"
                      name="mixMaterial[]"
                      required
                    >
                      <option value="perak">Perak - Rp 500.000</option>
                      <option value="palladium">Palladium - Rp 600.000</option>
                      <option value="platinum">Platinum - Rp 700.000</option>
                    </select>
                  </div>

                  <div class="mb-4">
                    <label for="goldMixPercentage" class="form-label"
                      >Persentase Emas (%)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="goldMixPercentage"
                      name="goldMixPercentage"
                      min="20"
                      max="100"
                      step="1"
                      placeholder="Masukkan persentase emas (20% - 100%)"
                      required
                    />
                  </div>

                  <div class="mb-4">
                    <label for="totalPrice" class="form-label"
                      >Total Harga (IDR)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="totalPrice"
                      name="totalPrice"
                      readonly
                    />
                  </div>

                  <div class="text-center">
                    <button
                      type="button"
                      class="btn btn-submit mb-2"
                      id="calculatePrice"
                    >
                      Hitung Harga
                    </button>
                    <button type="submit" class="btn btn-submit">
                      Pesan Sekarang
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container text-center">
        <p class="text-second">
          Toko Mas Duta Sumedang Online Store Copyright &copy; 2024 All Rights
          Reserved
        </p>
      </div>
    </footer>

    <script>
      // Mengecek apakah token kadaluarsa
      function isTokenExpired(token) {
        if (!token) return true;

        const payload = JSON.parse(atob(token.split(".")[1])); // Decode JWT untuk mendapatkan klaim
        const expirationTime = payload.exp * 1000; // Waktu kadaluarsa dalam milidetik
        const currentTime = Date.now();

        return currentTime > expirationTime;
      }

      // Menghitung Harga
      document
        .getElementById("calculatePrice")
        .addEventListener("click", () => {
          const goldType = document.getElementById("goldType").value;
          const goldWeight =
            parseFloat(document.getElementById("goldWeight").value) || 0;
          const mixMaterial = document.getElementById("mixMaterial").value;
          const goldMixPercentage =
            parseFloat(document.getElementById("goldMixPercentage").value) || 0;

          const goldPrices = { "24k": 1485700, "22k": 3121420, "18k": 1327100 };
          const mixPrices = {
            perak: 500000,
            palladium: 600000,
            platinum: 700000,
          };

          if (
            goldWeight <= 0 ||
            goldMixPercentage < 20 ||
            goldMixPercentage > 100
          ) {
            alert(
              "Silakan masukkan berat emas dan persentase emas yang valid."
            );
            return;
          }

          const goldPrice =
            goldWeight * (goldMixPercentage / 100) * goldPrices[goldType];
          const mixPrice = mixPrices[mixMaterial] || 0;
          const totalPrice = goldPrice + mixPrice;

          document.getElementById(
            "totalPrice"
          ).value = `Rp ${totalPrice.toLocaleString("id-ID")}`;
        });

      // Submit Form ke Backend
      document
        .getElementById("customOrderForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const token = localStorage.getItem("authToken"); // Mengambil token dengan key yang konsisten
          console.log("Token yang diambil dari localStorage:", token); // Log token yang diambil

          if (!token || isTokenExpired(token)) {
            // Cek apakah token ada atau kadaluarsa
            alert("Token kadaluarsa. Silakan login kembali.");
            window.location.href = "loginregis.html"; // Arahkan ke halaman login jika token kadaluarsa
            return;
          }

          // Ambil data form
          const productType = document.getElementById("productType").value;
          const goldType = document.getElementById("goldType").value;
          const goldWeight = parseFloat(
            document.getElementById("goldWeight").value
          );
          const mixMaterial = document.getElementById("mixMaterial").value;
          const goldMixPercentage = parseFloat(
            document.getElementById("goldMixPercentage").value
          );
          const totalPrice =
            parseFloat(
              document
                .getElementById("totalPrice")
                .value.replace("Rp ", "")
                .replace(/\./g, "")
            ) || 0;

          const orderData = {
            jenis_perhiasan: productType,
            jenis_emas: goldType,
            berat_emas: goldWeight,
            campuran_tambahan: mixMaterial,
            persentase_emas: goldMixPercentage,
            total_harga: totalPrice,
          };

          try {
            const response = await fetch(
              "http://localhost:8081/api/protected/orders",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`, // Kirim token di header Authorization
                },
                body: JSON.stringify(orderData),
              }
            );

            console.log("Response Status:", response.status); // Log status response

            if (response.status === 401) {
              alert("Token kadaluarsa. Silakan login kembali.");
              // Arahkan ke halaman login
              window.location.href = "loginregis.html";
              return;
            }

            if (response.ok) {
              const data = await response.json();
              alert("Pesanan berhasil dibuat! ID Pesanan: " + data.id);
              document.getElementById("customOrderForm").reset();
            } else {
              alert("Terjadi kesalahan saat memproses pesanan.");
              console.error(await response.text());
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Terjadi kesalahan saat menghubungi server.");
          }
        });
        document
        .getElementById("customOrderForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
      
          const token = localStorage.getItem("authToken");
      
          // Validasi token kadaluarsa
          if (!token || isTokenExpired(token)) {
            alert("Token kadaluarsa. Silakan login kembali.");
            window.location.href = "loginregis.html";
            return;
          }
      
          const productType = document.getElementById("productType").value;
          const goldType = document.getElementById("goldType").value;
          const goldWeight = parseFloat(document.getElementById("goldWeight").value);
          const mixMaterial = document.getElementById("mixMaterial").value;
          const goldMixPercentage = parseFloat(
            document.getElementById("goldMixPercentage").value
          );
          const totalPrice =
            parseFloat(
              document
                .getElementById("totalPrice")
                .value.replace("Rp ", "")
                .replace(/\./g, "")
            ) || 0;
      
          const orderData = {
            jenis_perhiasan: productType,
            jenis_emas: goldType,
            berat_emas: goldWeight,
            campuran_tambahan: mixMaterial,
            persentase_emas: goldMixPercentage,
            total_harga: totalPrice,
          };
      
          try {
            // Menyimpan pesanan ke localStorage sebelum mengirim ke server
            const cartData = JSON.parse(localStorage.getItem("cartData")) || [];
            cartData.push(orderData); // Menambahkan pesanan ke keranjang
            localStorage.setItem("cartData", JSON.stringify(cartData));
      
            // Melanjutkan ke backend setelah menyimpan di localStorage
            const response = await fetch(
              "http://localhost:8081/api/protected/orders",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(orderData),
              }
            );
      
            if (response.ok) {
              const data = await response.json();
              alert("Pesanan berhasil dibuat! ID Pesanan: " + data.id);
              document.getElementById("customOrderForm").reset();
              window.location.href = "cart.html"; // Arahkan ke halaman keranjang setelah pesanan dibuat
            } else {
              alert("Terjadi kesalahan saat memproses pesanan.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Terjadi kesalahan saat menghubungi server.");
          }
        });
      
    </script>
  </body>
</html>
