<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="library/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="style/main.css" />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <title>TOKO MAS DUTA SUMEDANG | Custom Jewelry</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f5f5;
      }

      .custom-form {
        background-color: #ffffff;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .custom-form h2 {
        font-weight: bold;
        color: #333333;
        margin-bottom: 20px;
      }

      .custom-form .form-label {
        font-weight: 600;
        color: #555555;
      }

      .custom-form .form-control,
      .custom-form .form-select {
        border-radius: 8px;
        border: 1px solid #cccccc;
        padding: 10px;
      }

      .custom-form .form-control:focus,
      .custom-form .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      .btn-submit {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        transition: background-color 0.3s ease;
      }

      .btn-submit:hover {
        background-color: #0056b3;
      }

      #preview-image {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        display: none;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .text-main {
        font-weight: bold;
        font-size: 1.5rem;
        color: #333333;
      }

      .text-center button {
        display: inline-block;
        margin: 5px; /* Jarak antar tombol jika ada */
      }

      .text-second {
        color: #777777;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="main-nav">
        <div class="brand text-main">
          <a href="https://proyek3webtokoemas.github.io/FEPROYEK1/">
            <h1>TOKO MAS DUTA SUMEDANG</h1>
          </a>
        </div>
        <div class="links">
          <ul>
            <li><a href="wedding.html">Wedding</a></li>
            <li><a href="custom.html" class="active">Custom</a></li>
            <li><a href="categories.html">Categories</a></li>
            <li><a href="blog.html">Blog</a></li>
            <li><a href="contacts.html">Contacts</a></li>
          </ul>
        </div>
        <div class="icon-for-user">
          <a href="loginregis.html">
            <img src="assets/icons/person.svg" alt="person" />
          </a>
          <a href="cart.html">
            <img src="assets/icons/shop-bag.svg" alt="shopping bag" />
          </a>
        </div>
      </nav>
    </header>

    <main>
      <section class="custom-section py-5">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-md-8">
              <div class="custom-form">
                <h2 class="text-center">Custom Jewelry Order</h2>
                <form id="customOrderForm">
                  <div class="mb-4">
                    <label for="productType" class="form-label"
                      >Jenis Perhiasan</label
                    >
                    <select
                      class="form-select"
                      id="productType"
                      name="productType"
                      required
                    >
                      <option value="cincin">Cincin</option>
                      <option value="gelang">Gelang</option>
                      <option value="kalung">Kalung</option>
                      <option value="anting">Anting</option>
                    </select>
                  </div>

                  <div class="mb-4">
                    <label for="goldType" class="form-label">Jenis Emas</label>
                    <select
                      class="form-select"
                      id="goldType"
                      name="goldType"
                      required
                    >
                      <option value="24k">Emas 24K - Rp 1.485.700</option>
                    </select>
                  </div>

                  <div class="mb-4">
                    <label for="goldWeight" class="form-label"
                      >Berat Emas (gram)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="goldWeight"
                      name="goldWeight"
                      min="1"
                      max="100"
                      placeholder="Masukkan berat emas"
                      required
                    />
                  </div>

                  <div class="mb-4">
                    <label for="mixMaterial" class="form-label"
                      >Campuran Tambahan</label
                    >
                    <select
                      class="form-select"
                      id="mixMaterial"
                      name="mixMaterial[]"
                      required
                    >
                      <option value="perak">Perak - Rp 500.000</option>
                      <option value="palladium">Palladium - Rp 600.000</option>
                      <option value="platinum">Platinum - Rp 700.000</option>
                    </select>
                  </div>

                  <div class="mb-4">
                    <label for="goldMixPercentage" class="form-label"
                      >Persentase Emas (%)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="goldMixPercentage"
                      name="goldMixPercentage"
                      min="20"
                      max="100"
                      step="1"
                      placeholder="Masukkan persentase emas (20% - 100%)"
                      required
                    />
                  </div>

                  <div class="mb-4">
                    <label for="totalPrice" class="form-label"
                      >Total Harga (IDR)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="totalPrice"
                      name="totalPrice"
                      readonly
                    />
                  </div>

                  <div class="text-center">
                    <button
                      type="button"
                      class="btn btn-submit mb-2"
                      id="calculatePrice"
                    >
                      Hitung Harga
                    </button>
                    <button type="submit" class="btn btn-submit">
                      Pesan Sekarang
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="container text-center">
        <p class="text-second">
          Toko Mas Duta Sumedang Online Store Copyright &copy; 2024 All Rights
          Reserved
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      async function fetchMetalPrice() {
        const apiKey = '7ffa7a6fe6851aa6e72b813758e274fb'; // API Key Anda
        try {
          const response = await fetch('https://api.metalpriceapi.com/v1/latest', {
            headers: {
              'X-API-KEY': apiKey,
              'Content-Type': 'application/json',
            },
          });
          const data = await response.json();
          const xauRate = data.rates['XAU']; // Nilai XAU dari API
          const idrRate = data.rates['IDR']; // Kurs USD ke IDR dari API
    
          // Harga emas per troy ounce dalam IDR
          const goldPricePerOunceInIDR = (1 / xauRate) * idrRate;
    
          // Harga emas per gram dalam IDR
          const goldPricePerGramInIDR = goldPricePerOunceInIDR / 31.1035;
    
          // Update global harga emas
          window.goldPricePerGram = goldPricePerGramInIDR;
        } catch (error) {
          console.error('Error fetching metal price:', error);
          Swal.fire({
            icon: 'error',
            title: 'Gagal Mendapatkan Data Harga Emas',
            text: 'Pastikan koneksi internet stabil.',
          });
        }
      }
    
      function isTokenExpired(token) {
        if (!token) return true;
    
        const payload = JSON.parse(atob(token.split('.')[1])); // Decode JWT
        const expirationTime = payload.exp * 1000;
        const currentTime = Date.now();
    
        return currentTime > expirationTime;
      }
    
      function getUserIdFromToken(token) {
        if (!token) return null;
    
        const payload = JSON.parse(atob(token.split('.')[1])); // Decode JWT
        return payload.email; // Menggunakan email sebagai identifikasi user unik
      }
    
      document.getElementById('calculatePrice').addEventListener('click', () => {
        const goldType = document.getElementById('goldType').value;
        const goldWeight = parseFloat(document.getElementById('goldWeight').value) || 0;
        const mixMaterial = document.getElementById('mixMaterial').value;
        const goldMixPercentage = parseFloat(document.getElementById('goldMixPercentage').value) || 0;
    
        const goldPurity = { '24k': 1, '22k': 0.916, '18k': 0.75 };
        const mixPrices = { perak: 500000, palladium: 600000, platinum: 700000 };
    
        if (goldWeight <= 0 || goldMixPercentage < 20 || goldMixPercentage > 100 || !window.goldPricePerGram) {
          Swal.fire({
            icon: 'error',
            title: 'Data tidak valid',
            text: 'Silakan masukkan berat emas, persentase emas, dan pastikan harga emas diperbarui.',
          });
          return;
        }
    
        const goldPrice =
          goldWeight *
          goldPurity[goldType] *
          (goldMixPercentage / 100) *
          window.goldPricePerGram;
        const mixPrice = mixPrices[mixMaterial] || 0;
        const totalPrice = goldPrice + mixPrice;
    
        document.getElementById('totalPrice').value = `Rp ${totalPrice.toLocaleString('id-ID')}`;
      });
    
      document.getElementById('customOrderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
    
        const token = localStorage.getItem('authToken');
    
        if (!token || isTokenExpired(token)) {
          Swal.fire({
            icon: 'error',
            title: 'Token kadaluarsa',
            text: 'Silakan login kembali.',
          }).then(() => {
            window.location.href = 'loginregis.html';
          });
          return;
        }
    
        const productType = document.getElementById('productType').value;
        const goldType = document.getElementById('goldType').value;
        const goldWeight = parseFloat(document.getElementById('goldWeight').value);
        const mixMaterial = document.getElementById('mixMaterial').value;
        const goldMixPercentage = parseFloat(document.getElementById('goldMixPercentage').value);
        const totalPrice =
          parseFloat(
            document.getElementById('totalPrice').value.replace('Rp ', '').replace(/\./g, '')
          ) || 0;
    
        const orderData = {
          jenis_perhiasan: productType,
          jenis_emas: goldType,
          berat_emas: goldWeight,
          campuran_tambahan: mixMaterial,
          persentase_emas: goldMixPercentage,
          total_harga: totalPrice,
        };
    
        try {
          const response = await fetch('https://be-3.vercel.app/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(orderData),
          });
    
          if (response.status === 401) {
            Swal.fire({
              icon: 'error',
              title: 'Token kadaluarsa',
              text: 'Silakan login kembali.',
            }).then(() => {
              window.location.href = 'loginregis.html';
            });
            return;
          }
    
          if (response.ok) {
            const data = await response.json();
            const userId = getUserIdFromToken(token);
    
            // Simpan data pesanan ke localStorage berdasarkan userId
            const userOrders = JSON.parse(localStorage.getItem(`orders_${userId}`)) || [];
            userOrders.push(data);
            localStorage.setItem(`orders_${userId}`, JSON.stringify(userOrders));
    
            Swal.fire({
              icon: 'success',
              title: 'Pesanan Berhasil',
              text: `Pesanan berhasil dibuat! ID Pesanan: ${data.id}`,
            });
            document.getElementById('customOrderForm').reset();
          } else {
            const errorMessage = await response.text();
            Swal.fire({
              icon: 'error',
              title: 'Kesalahan Server',
              text: `Terjadi kesalahan: ${errorMessage}`,
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Kesalahan',
            text: 'Tidak dapat terhubung ke server.',
          });
          console.error('Error:', error);
        }
      });
    
      fetchMetalPrice();
    </script>
    

  </body>
</html>
